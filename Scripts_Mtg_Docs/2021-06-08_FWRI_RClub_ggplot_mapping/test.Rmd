---
title: "Simple maps with ggplot"
author: "M. Schrandt"
date: "5/24/2021"
output:
  html_document: default
  pdf_document: default
---

## Introduction

Often we want to plot geospatial data for something simple, like a map that shows occurrence of species counts in our sampling area, static maps for publications, etc.

Today, we'll briefly cover how to get started with simple maps in ggplot. There are many ways to approach this, but I'll try to get you started. We'll make use of the r packages `r tidyverse` (which contains `r ggplot`) and `r sf`.

```{r setup}
## Load Libraries
library(tidyverse)
library(sf)
library(ggspatial) # north arrow and scale bar for map
```

## Our Data 

We'll be using a dataset available on Mendeley Data. It contains fish count data for 7 species of reef fish. The data are from a fisheries-independent monitoring survey of polyhaline seagrass beds along the West Florida Shelf, from 2008 to 2019.

The detailed state of Florida shoreline shapefile is large, so we're going to subset the data to just Tampa Bay, and use a smaller shapefile to help with quicker rendering for this example.

```{r readPointData}
#  Reef fish species counts (including zeroes) from seagrass beds along West Florida Shelf
#   These data are available on Mendeley Data: http://dx.doi.org/10.17632/9bzshm5h46.1
fishdat <- read.csv("Catch_Env_Data_new.csv", header = TRUE, stringsAsFactors = FALSE) %>%
  # reduce our columns; not all are needed
  select(Reference, Scientificname, N, Bay, Gear, Year, Month, Zone, Longitude, Latitude) %>%
  filter(Bay == "TB")

head(fishdat)
```

If we're making a static map for a paper or publication, we're also likely going to want/need a basemap shapefile.
```{r readBase}
# Read in shapefile of TB geo
TBshore_sf <- read_sf(dsn = ".", layer = "tb_geo") %>%
  #just keep the geometry column since that's all we need for this exercise (it contains lat/lon)
  select(geometry) %>%
  st_make_valid()

# check coordinate reference system
st_crs(TBshore_sf)
```
The coordinate reference system (CRS) is set to NAD83. Location data are collected using GPS, which typically uses the WGS84 crs (you'll want to check your unit to see how it records). Therefore, we are going to want to change the crs of the base layer so that our points are projecting in the correct crs.

```{r changeCRS}
st_transform(TBshore_sf, crs = 4326)
st_crs(TBshore_sf)
```

## Plot our Base Map

If you're familiar with plotting in ggplot, mapping really isn't too different at all. We can take advantage of the layering aspect of ggplot; I like to build my maps from the bottom layer to the top, to make sure everything is visible.

I use the `r geom_sf()` function to plot my shapefiles. If you call `r str(FLshoreline_sf)`, you'll see it is a "POLYGON"...so if we want to color in the polygon, we use the `r fill` argument. If you want a different color for the outline, then use the `r color` argument. You can change the thickness of the lines with the `r size` argument.

```{r basemap}
base <- ggplot() +
  geom_sf(data = TBshore_sf, fill = "gray90", size = 0.1)
base
```

This shapefile was actually cropped from the state of Florida shoreline shapefile; we can set the boundaries of our map with `r coord_sf()`.

```{r}
base <- ggplot() +
  geom_sf(data = TBshore_sf, fill = "gray90", size = 0.1) +
  #set extent of coordinates
  coord_sf(xlim = c(-82.9, -82.2), ylim = c(27.3, 28.15), expand = FALSE) +
  theme_classic()
base
```


## Add All Point Data

We can use `r geom_point()` if our point data are not a shapefile, but we need to specify the lat/lon. You'll need the column names of your latitude and longitude in your point data file. For `r fishdat` they are called "Latitude" and "Longitude"
```{r addPoints}
base + geom_point(data = fishdat, aes(x = Longitude, y = Latitude), size = 1.5, color = "blue")
```

You'll notice all the points fall in the southern portion of the estuary; this makes sense since the survey is in polyhaline seagrass beds where the salinity is >= 18.

The better alternative is to turn your point data into an `r sf` object. This will rely on `r sf` to handle "on-the-fly" coordinate systems - this is very useful if your two objects (base map and point data) are not in the same projection.
```{r makeShape}
#crs 4326 is for WGS84, which is the crs of our base map shapefile
fishdat_sf <- st_as_sf(fishdat, coords = c("Longitude", "Latitude"), crs = 4326)
head(fishdat_sf)
```
*Note: Your `r fishdat_sf` dataset has 1 less column than the original, because the latitude and longitude have been combined into a single column called `r geometry`.*

Also of note is the "bounding box" in the output. This is helpful if you want to set the limits of your map to the bounding box of this layer.

Now we can use `r geom_sf()` for our `r sf` object. Here I will change the point color to red so we know it's a different map.
```{r pointSF, message = FALSE, warning = FALSE}
p1 <- ggplot() +
  geom_sf(data = TBshore_sf, fill = "gray90", size = 0.1) +
  geom_sf(data = fishdat_sf, size = 1.5, color = "red") +
  # you will need to re-do the limits
  coord_sf(xlim = c(-82.9, -82.2), ylim = c(27.3, 28.15), expand = FALSE) + 
  theme_classic()
p1
```

## Add Features with the `r ggspatial` package

We can grab a north arrow and scale from the `r ggspatial` package
```{r}
p1 +
  #location "br" here refers to "bottom right"
  annotation_north_arrow(location = "br", which_north = "true", style = north_arrow_nautical(),
                         pad_x = unit(0.5, "cm"), pad_y = unit(0.5, "cm")) +
  annotation_scale(location = "br", width_hint = 0.25)
```

## You can save your map with `r ggsave()`.

## Examples of other ggplot features you can use...

Example: To color the points by gear type, use `r aes()`:
```{r}
p2 <- ggplot() +
  geom_sf(data = TBshore_sf, fill = "gray90", size = 0.1) +
  geom_sf(data = fishdat_sf, size = 1.5, aes(color = as.factor(Gear))) +
  # you will need to re-do the limits
  coord_sf(xlim = c(-82.9, -82.2), ylim = c(27.3, 28.15), expand = FALSE) + 
  theme_classic()
p2

```

Example: Use `r facet_grid()` or `r facet_wrap()`
```{r}
p3 <- ggplot() +
  geom_sf(data = TBshore_sf, fill = "gray90", size = 0.1) +
  geom_sf(data = fishdat_sf, size = 1.5, aes(color = as.factor(Gear))) +
  facet_wrap(~Gear, ncol = 2) +
  # you will need to re-do the limits
  coord_sf(xlim = c(-82.9, -82.2), ylim = c(27.3, 28.15), expand = FALSE) + 
  theme_classic()
p3
```

